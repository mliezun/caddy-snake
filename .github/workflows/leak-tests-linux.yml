---
    name: Leak Tests Linux
    on:
      pull_request:
        branches:
          - main
      push:
        branches:
          - main
    jobs:
      tests:
        runs-on: ubuntu-24.04
        strategy:
          fail-fast: false
          matrix:
            tool-name: ['django', 'socketio']
            python-version: ['3.13']
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-go@v5
            with:
              go-version: '1.26'
              cache: false
          - name: Install Xcaddy
            run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
          - name: Set up Python ${{ matrix.python-version }}
            working-directory: tests/${{ matrix.tool-name }}/
            run: |
              export DEBIAN_FRONTEND=noninteractive
              sudo apt-get update -yyqq
              sudo apt-get install -yyqq software-properties-common
              sudo add-apt-repository -y ppa:deadsnakes/ppa
              sudo apt-get install -yyqq python${{ matrix.python-version }}-venv
              rm -rf venv
              python${{ matrix.python-version }} -m venv venv
              source venv/bin/activate
              pip install -r requirements.txt
          - name: Build the server
            working-directory: tests/${{ matrix.tool-name }}/
            run: CGO_ENABLED=0 xcaddy build --with github.com/mliezun/caddy-snake=../..
          - name: Run integration tests
            working-directory: tests/${{ matrix.tool-name }}/
            run: |
              ./caddy run --config Caddyfile > caddy.log 2>&1 &
              timeout 60 bash -c 'while ! grep -q "finished cleaning storage units" caddy.log; do sleep 1; done'
              source venv/bin/activate
              python main_test.py
          - name: Upload logs and report
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: caddy-leak-tests-logs-${{ matrix.tool-name }}-${{ matrix.python-version }}
              path: |
                tests/${{ matrix.tool-name }}/caddy.log
