---
    name: Go Tests
    on:
      pull_request:
        branches:
          - main
      push:
        branches:
          - main
    permissions:
      contents: write
    jobs:
      tests:
        runs-on: ubuntu-24.04
        strategy:
          fail-fast: false
          matrix:
            python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
            architecture: ['x86_64', 'arm64']
        env:
          GOEXPERIMENT: cgocheck2
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-go@v5
            with:
              go-version: '1.25'
              cache: false
          - name: Install Xcaddy
            run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
          - name: Set up QEMU
            if: matrix.architecture == 'arm64'
            uses: docker/setup-qemu-action@v3
            with:
              platforms: arm64
          - name: Install cross-compilation toolchain
            if: matrix.architecture == 'arm64'
            run: |
              export DEBIAN_FRONTEND=noninteractive
              sudo apt-get update -yyqq
              sudo apt-get install -yyqq gcc-aarch64-linux-gnu
          - name: Set up Python ${{ matrix.python-version }}
            run: |
              export DEBIAN_FRONTEND=noninteractive
              sudo apt-get update -yyqq
              sudo apt-get install -yyqq software-properties-common
              sudo add-apt-repository -y ppa:deadsnakes/ppa
              sudo apt-get install -yyqq python${{ matrix.python-version }}-dev python${{ matrix.python-version }}-venv
              if [ "${{ matrix.architecture }}" = "x86_64" ]; then
                sudo mv /usr/lib/x86_64-linux-gnu/pkgconfig/python-${{ matrix.python-version }}-embed.pc /usr/lib/x86_64-linux-gnu/pkgconfig/python3-embed.pc
              elif [ "${{ matrix.architecture }}" = "arm64" ]; then
                if [ -f /usr/lib/aarch64-linux-gnu/pkgconfig/python-${{ matrix.python-version }}-embed.pc ]; then
                  sudo mv /usr/lib/aarch64-linux-gnu/pkgconfig/python-${{ matrix.python-version }}-embed.pc /usr/lib/aarch64-linux-gnu/pkgconfig/python3-embed.pc
                fi
              fi
          - name: Install global python dependencies
            run: sudo pip install requests
          - name: Run module tests
            run: |
              if [ "${{ matrix.architecture }}" = "arm64" ]; then
                export GOARCH=arm64
                export GOOS=linux
                export CGO_ENABLED=1
                export CC=aarch64-linux-gnu-gcc
              fi
              go test -race -v .
          - name: Update coverage report
            uses: ncruces/go-coverage-report@v0
            continue-on-error: true
          - name: Build the server
            run: |
              if [ "${{ matrix.architecture }}" = "arm64" ]; then
                export GOARCH=arm64
                export GOOS=linux
                export CGO_ENABLED=1
                export CC=aarch64-linux-gnu-gcc
              else
                export CGO_ENABLED=1
              fi
              xcaddy build --with github.com/mliezun/caddy-snake=.
          